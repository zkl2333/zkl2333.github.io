name: 更新 GitHub 数据

on:
    # 定时任务：每天 UTC 时间 19:00（北京时间凌晨 3:00）执行
    schedule:
        - cron: "0 19 * * *"
    # 允许手动触发
    workflow_dispatch:

# 设置 GITHUB_TOKEN 权限
permissions:
    contents: write

jobs:
    update-data:
        runs-on: ubuntu-latest
        steps:
            - name: 检出代码
              uses: actions/checkout@v4

            - name: 设置 Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: 安装依赖
              run: npm ci

            - name: 获取 GitHub 数据
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  npm run fetch-data
                  npm run generate:icons

            - name: 提交并推送数据文件
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add public/data/*.json
                  git diff --quiet && git diff --staged --quiet || git commit -m "chore: 更新 GitHub 数据 [skip ci]"
                  git push
